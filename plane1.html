<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÁêâÁêÉ‰πãÊàò - Keygen Melody</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; touch-action: none; display: flex; justify-content: center; align-items: center; height: 100vh; font-family: "Microsoft YaHei", sans-serif; user-select: none; -webkit-user-select: none; }
        #gameContainer { position: relative; width: 100%; max-width: 480px; height: 100%; background: #000; box-shadow: 0 0 50px #001; }
        canvas { width: 100%; height: 100%; display: block; }
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 20; color: white; backdrop-filter: blur(8px); transition: opacity 0.4s; }
        .hidden { opacity: 0; pointer-events: none; }
        h1 { font-size: 56px; margin: 0 0 10px 0; background: linear-gradient(to bottom, #ff3333, #ffcc00); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 900; letter-spacing: 4px; text-shadow: 0 5px 20px rgba(255, 0, 0, 0.5); filter: drop-shadow(0 0 5px rgba(255,200,0,0.5)); }
        .hud { position: absolute; top: 15px; left: 15px; width: 90%; display: flex; justify-content: space-between; color: #fff; font-weight: 800; font-size: 14px; z-index: 5; text-shadow: 1px 1px 2px #000; pointer-events: none; }
        .boss-hp-bar { position: absolute; top: 50px; left: 10%; width: 80%; height: 10px; background: #333; border: 1px solid #fff; display: none; box-shadow: 0 0 10px #f00; }
        .boss-hp-fill { width: 100%; height: 100%; background: #f00; transition: width 0.1s; }
        #studioLogo { position: absolute; bottom: 15px; width: 100%; text-align: center; color: rgba(255, 255, 255, 0.4); font-size: 12px; font-weight: bold; letter-spacing: 2px; pointer-events: none; z-index: 2; font-family: 'Segoe UI', monospace; animation: breathe 4s infinite ease-in-out; }
        @keyframes breathe { 0%, 100% { opacity: 0.3; } 50% { opacity: 0.7; color: #00f3ff; } }
        @keyframes hue { 0% { filter: hue-rotate(0deg); } 100% { filter: hue-rotate(360deg); } }
        #controls { position: absolute; bottom: 70px; width: 100%; height: 160px; pointer-events: none; padding: 0 25px; box-sizing: border-box; display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        .d-pad { width: 150px; height: 150px; position: relative; pointer-events: auto; background: rgba(255,255,255,0.05); border-radius: 50%; border: 1px solid rgba(255,255,255,0.1); }
        .d-btn { position: absolute; background: rgba(255,255,255,0.15); border-radius: 8px; backdrop-filter: blur(2px); }
        .d-up { top: 10px; left: 50px; width: 50px; height: 50px; }
        .d-down { bottom: 10px; left: 50px; width: 50px; height: 50px; }
        .d-left { top: 50px; left: 10px; width: 50px; height: 50px; }
        .d-right { top: 50px; right: 10px; width: 50px; height: 50px; }
        .fire-btn { width: 90px; height: 90px; border-radius: 50%; background: linear-gradient(135deg, rgba(255, 50, 50, 0.4), rgba(150, 0, 0, 0.4)); border: 2px solid rgba(255, 80, 80, 0.8); pointer-events: auto; display: flex; justify-content: center; align-items: center; font-weight: 900; font-size: 20px; color: #fff; margin-bottom: 20px; box-shadow: 0 0 20px rgba(255,0,0,0.4); font-family: "Microsoft YaHei"; }
        .fire-btn:active { background: #f00; transform: scale(0.95); }
        button.start-btn { margin-top: 15px; padding: 12px 60px; background: #00f3ff; color: #000; font-weight: bold; font-size: 24px; cursor: pointer; border: none; clip-path: polygon(15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%, 0 15px); transition: transform 0.2s; font-family: "Microsoft YaHei"; box-shadow: 0 0 20px rgba(0, 243, 255, 0.4); }
        button.start-btn:hover { transform: scale(1.05); background: #fff; }
    </style>
</head>
<body>

<div id="gameContainer">
    <div class="hud">
        <div id="scoreDisplay">ÂæóÂàÜ: 0</div>
        <div id="timerDisplay" style="color:#00ff00">Ë∑ùÊïåËà∞: 120s</div>
        <div id="weaponDisplay" style="color:#00f3ff">ÁÅ´Âäõ: 1Á∫ß</div>
    </div>
    
    <div id="bossHpBar" class="boss-hp-bar"><div id="bossHpFill" class="boss-hp-fill"></div></div>
    <canvas id="gameCanvas"></canvas>
    
    <div id="controls">
        <div class="d-pad">
            <div class="d-btn d-up" data-key="ArrowUp"></div>
            <div class="d-btn d-down" data-key="ArrowDown"></div>
            <div class="d-btn d-left" data-key="ArrowLeft"></div>
            <div class="d-btn d-right" data-key="ArrowRight"></div>
        </div>
        <div class="fire-btn" data-key="Space">ÂºÄÁÅ´</div>
    </div>
    
    <div id="studioLogo">Â∞èÊæçSOFTWARE STUDIO</div>

    <div id="startScreen" class="overlay">
        <h1>ÁêâÁêÉ‰πãÊàò</h1>
        <canvas id="coverCanvas" width="340" height="220" style="width:340px; height:220px; margin-bottom:20px;"></canvas>
        <button class="start-btn" onclick="Game.init()">Âá∫Âáª</button>
        <p style="font-size:12px; color:#888; margin-top:10px;">üîä Êé®Ëçê‰Ω©Êà¥ËÄ≥Êú∫ | BGM: Keygen Jazz Pro</p>
    </div>

    <div id="victoryScreen" class="overlay hidden">
        <h1 style="font-size: 40px; color:#ffeb3b; text-shadow: 0 0 20px orange;">ÊàòÊñóËÉúÂà©</h1>
        <p id="victoryText" style="font-size:24px; color: #fff; margin:20px 0; font-weight:bold;">ÂáªË¥•Ëà™Á©∫Ëá™Âç´ÈòüÁ¨¨ 1 Â∏àÂõ¢</p>
        <button class="start-btn" onclick="Game.nextLevel()">ÁªßÁª≠ËøΩÂáª</button>
    </div>

    <div id="gameOverScreen" class="overlay hidden">
        <h1 style="font-size: 40px; color:#ff3333;">‰ªªÂä°Â§±Ë¥•</h1>
        <p id="finalScore" style="font-size:28px; color: #ffeb3b; margin:20px 0;">0</p>
        <button class="start-btn" onclick="Game.restart()">ÈáçÊù•</button>
    </div>
</div>

<script>
// --- üéµ KEYGEN JAZZ FUSION ENGINE (MELODY REWORKED) ---
const AudioSys = {
    ctx: null, isPlaying: false, theme: 'battle',
    tempo: 160, nextNoteTime: 0, step: 0, bar: 0,
    
    // Jazz Chords (D Minor 9 -> G13 -> CMAJ9 -> A7alt)
    jazzChords: [
        { root: 293.66, notes: [293.66, 349.23, 440.00, 523.25, 659.25], scale: [293.66, 329.63, 349.23, 392.00, 440.00, 493.88, 523.25, 587.33, 659.25] },
        { root: 196.00, notes: [196.00, 246.94, 293.66, 349.23, 329.63], scale: [196.00, 220.00, 246.94, 293.66, 329.63, 349.23, 392.00, 440.00, 493.88] },
        { root: 261.63, notes: [261.63, 329.63, 392.00, 493.88, 587.33], scale: [261.63, 293.66, 329.63, 349.23, 392.00, 440.00, 493.88, 523.25, 587.33] },
        { root: 220.00, notes: [220.00, 277.18, 392.00, 523.25], scale: [220.00, 233.08, 277.18, 311.13, 329.63, 392.00, 415.30, 440.00, 523.25] }
    ],
    // Boss Tension
    bossChords: [
        { root: 146.83, notes: [146.83, 174.61, 220.00], scale: [146.83, 155.56, 174.61, 196.00, 220.00, 233.08] },
        { root: 138.59, notes: [138.59, 164.81, 207.65], scale: [138.59, 146.83, 164.81, 196.00, 207.65] },
        { root: 130.81, notes: [130.81, 155.56, 196.00], scale: [130.81, 138.59, 155.56, 185.00, 196.00] },
        { root: 123.47, notes: [123.47, 146.83, 185.00], scale: [123.47, 130.81, 146.83, 174.61, 185.00] }
    ],

    init: function() {
        window.AudioContext = window.AudioContext || window.webkitAudioContext;
        this.ctx = new AudioContext();
        if(this.ctx.state === 'suspended') this.ctx.resume();
        this.isPlaying = true;
        this.nextNoteTime = this.ctx.currentTime + 0.1;
        this.step = 0; this.bar = 0;
        this.schedule();
    },

    setTheme: function(t) {
        this.theme = t;
        this.tempo = (t === 'boss') ? 175 : 160;
    },

    playOsc: function(freq, t, dur, type, vol, detune=0, slideTo=null) {
        if(!this.ctx || !freq) return;
        const o = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        o.type = type; o.frequency.value = freq;
        if(detune) o.detune.value = detune;
        if(slideTo) o.frequency.exponentialRampToValueAtTime(slideTo, t+dur);
        g.gain.setValueAtTime(vol, t);
        g.gain.exponentialRampToValueAtTime(0.001, t + dur);
        o.connect(g); g.connect(this.ctx.destination);
        o.start(t); o.stop(t + dur);
    },

    // ‚òÖ‚òÖ‚òÖ NEW SOLO INSTRUMENT: SWEET CHIPTUNE LEAD ‚òÖ‚òÖ‚òÖ
    playSoloNote: function(freq, t, len) {
        // Main Square (Classic Gameboy vibe)
        this.playOsc(freq, t, len, 'square', 0.08, 0);
        // Subtle Saw for "bite"
        this.playOsc(freq, t, len, 'sawtooth', 0.04, 5); 
        // High sparkle (Octave up)
        this.playOsc(freq*2, t, len*0.5, 'square', 0.03, 0);
        // Delay/Echo effect
        this.playOsc(freq, t + 0.12, len*0.8, 'square', 0.02, 0);
    },

    // ‚òÖ‚òÖ‚òÖ THE KEYGEN ARPEGGIATOR (The "Brrrrt" Sound) ‚òÖ‚òÖ‚òÖ
    playFastArp: function(baseFreq, t) {
        const gap = 0.035; // 35ms rapid fire
        // Root -> 3rd -> 5th -> 9th (Sweet Jazz Color)
        this.playOsc(baseFreq, t, 0.06, 'square', 0.08);
        this.playOsc(baseFreq * 1.25, t + gap, 0.06, 'square', 0.08); // Major 3rd feel
        this.playOsc(baseFreq * 1.5, t + gap*2, 0.06, 'square', 0.08); // 5th
        this.playOsc(baseFreq * 2.25, t + gap*3, 0.06, 'square', 0.07); // 9th (High)
    },

    playBass: function(freq, t) {
        const o = this.ctx.createOscillator(); const g = this.ctx.createGain(); const f = this.ctx.createBiquadFilter();
        o.type = 'square'; o.frequency.value = freq / 2;
        f.type = 'lowpass'; f.frequency.setValueAtTime(150, t); f.frequency.exponentialRampToValueAtTime(80, t + 0.3);
        g.gain.setValueAtTime(0.2, t); g.gain.linearRampToValueAtTime(0, t + 0.3);
        o.connect(f); f.connect(g); g.connect(this.ctx.destination); o.start(t); o.stop(t + 0.3);
    },

    playChord: function(chordObj, t) {
        chordObj.notes.forEach((freq, i) => {
            let type = (this.theme === 'boss') ? 'sawtooth' : 'triangle';
            let vol = (this.theme === 'boss') ? 0.03 : 0.04;
            this.playOsc(freq, t + (i*0.01), 1.5, type, vol);
        });
    },

    playKick: function(t) { const o = this.ctx.createOscillator(); const g = this.ctx.createGain(); o.frequency.setValueAtTime(150, t); o.frequency.exponentialRampToValueAtTime(0.01, t+0.15); g.gain.setValueAtTime(0.8, t); g.gain.exponentialRampToValueAtTime(0.01, t+0.15); o.connect(g); g.connect(this.ctx.destination); o.start(t); o.stop(t+0.15); },
    playSnare: function(t) { const b=this.ctx.createBuffer(1,this.ctx.sampleRate*0.1,this.ctx.sampleRate); const d=b.getChannelData(0); for(let i=0;i<d.length;i++)d[i]=Math.random()*2-1; const s=this.ctx.createBufferSource(); s.buffer=b; const g=this.ctx.createGain(); g.gain.setValueAtTime(0.4,t); g.gain.exponentialRampToValueAtTime(0.01,t+0.1); const f=this.ctx.createBiquadFilter(); f.type='highpass'; f.frequency.value=800; s.connect(f); f.connect(g); g.connect(this.ctx.destination); s.start(t); },
    playHihat: function(t, open) { const b=this.ctx.createBuffer(1,this.ctx.sampleRate*(open?0.1:0.04),this.ctx.sampleRate); const d=b.getChannelData(0); for(let i=0;i<d.length;i++)d[i]=(Math.random()*2-1); const s=this.ctx.createBufferSource(); s.buffer=b; const f=this.ctx.createBiquadFilter(); f.type='highpass'; f.frequency.value=7000; const g=this.ctx.createGain(); g.gain.value=open?0.1:0.04; s.connect(f); f.connect(g); g.connect(this.ctx.destination); s.start(t); },
    playSiren: function(t) { this.playOsc(800, t, 0.4, 'sawtooth', 0.1, 0, 400); },
    playShoot: function() { if(!this.ctx) return; const t = this.ctx.currentTime; const o = this.ctx.createOscillator(); const g = this.ctx.createGain(); o.type = 'sine'; o.frequency.setValueAtTime(2500, t); o.frequency.exponentialRampToValueAtTime(100, t + 0.1); g.gain.setValueAtTime(0.15, t); g.gain.exponentialRampToValueAtTime(0.01, t + 0.1); o.connect(g); g.connect(this.ctx.destination); o.start(t); o.stop(t + 0.1); },

    schedule: function() {
        const secondsPerBeat = 60.0 / this.tempo;
        const s16 = secondsPerBeat / 4; 

        while(this.nextNoteTime < this.ctx.currentTime + 0.1) {
            const step16 = this.step % 16;
            const bar4 = Math.floor(this.step / 16) % 4;
            const currentChords = (this.theme === 'boss') ? this.bossChords : this.jazzChords;
            const chord = currentChords[bar4];
            
            // --- Rhythm Section (Unchanged) ---
            if(this.theme === 'boss') {
                if(step16 % 2 === 0) this.playKick(this.nextNoteTime);
                if(step16 === 4 || step16 === 12) this.playSnare(this.nextNoteTime);
                this.playHihat(this.nextNoteTime, step16%4===2);
                if(step16 % 2 === 0) this.playBass(chord.root/2, this.nextNoteTime);
            } else {
                const k = [1,0,0,0, 0,0,0,0, 1,0,1,0, 0,0,0,0];
                const s = [0,0,0,0, 1,0,0,1, 0,0,0,0, 1,0,0,1];
                if(k[step16]) this.playKick(this.nextNoteTime);
                if(s[step16]) this.playSnare(this.nextNoteTime);
                if(step16%2!==0) this.playHihat(this.nextNoteTime, step16===2||step16===14);
                const bassRhythm = [1,0,0,1, 0,0,1,0, 0,1,0,0, 1,0,0,1];
                if(bassRhythm[step16]) this.playBass(chord.root, this.nextNoteTime);
            }

            if(step16 === 0) {
                this.playChord(chord, this.nextNoteTime);
                if(this.theme === 'boss') this.playSiren(this.nextNoteTime);
            }

            // --- ‚òÖ‚òÖ‚òÖ REWORKED MELODY SEQUENCER (STRUCTURED KEYGEN) ‚òÖ‚òÖ‚òÖ ---
            if (this.theme === 'battle') {
                // Determine melody type based on Bar
                // Bar 0, 1, 2: Rhythmic Arps & Chords
                // Bar 3: Fast Scale Run (Fill)
                
                const notes = chord.scale;
                const root = chord.root;
                
                // Pattern Logic: Keygen Style
                // Beat 1 (0): Arpeggio Burst (Brrrrt)
                if(step16 === 0) {
                    this.playFastArp(root * (bar4 >= 2 ? 2 : 1), this.nextNoteTime);
                }
                // Beat 1 Off (2, 3): Staccato melody notes
                else if(step16 === 2 || step16 === 3) {
                    let n = notes[(bar4 + step16) % notes.length] * (bar4 >= 2 ? 2 : 1);
                    this.playSoloNote(n, this.nextNoteTime, 0.1);
                }
                // Beat 2 (4): Rest or Long note
                else if(step16 === 4 && bar4 % 2 === 1) {
                    this.playSoloNote(notes[4] * (bar4>=2?2:1), this.nextNoteTime, 0.3);
                }
                // Beat 3 (8): High Arpeggio Burst
                else if(step16 === 8) {
                    this.playFastArp(root * 2, this.nextNoteTime);
                }
                // Beat 4 (12-15): Fast Run (The "Fill")
                else if(step16 >= 12) {
                    // 16th note scale run
                    let idx = (step16 % 4) + (bar4 * 2);
                    let n = notes[idx % notes.length] * 2; 
                    this.playSoloNote(n, this.nextNoteTime, 0.1);
                }
            } else {
                // Boss melody (Chaotic as before)
                if(step16 % 2 === 0) {
                    let idx = (step16 + bar4) % chord.scale.length;
                    this.playSoloNote(chord.scale[idx] * 2, this.nextNoteTime, 0.1);
                }
            }

            this.nextNoteTime += s16;
            this.step++;
        }
        if(this.isPlaying) requestAnimationFrame(this.schedule.bind(this));
    }
};

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const scoreEl = document.getElementById('scoreDisplay');
const timerEl = document.getElementById('timerDisplay');
const weaponEl = document.getElementById('weaponDisplay');
const bossHpBar = document.getElementById('bossHpBar');
const bossHpFill = document.getElementById('bossHpFill');

function resize() {
    const box = document.getElementById('gameContainer');
    canvas.width = box.clientWidth;
    canvas.height = box.clientHeight;
}
window.onresize = resize;
resize();

function drawChinaFlag(ctx, x, y, width) {
    let height = width * 2 / 3;
    ctx.fillStyle = "#DE2910"; ctx.fillRect(x, y, width, height);
    drawStar(ctx, x + width*0.15, y + height*0.25, width*0.09, width*0.036, "#FFDE00");
    let positions = [[0.3, 0.1], [0.36, 0.18], [0.36, 0.32], [0.3, 0.4]];
    positions.forEach(pos => drawStar(ctx, x + width*pos[0], y + height*pos[1], width*0.03, width*0.012, "#FFDE00"));
}
function drawJapanFlag(ctx, x, y, width) {
    let height = width * 2 / 3;
    ctx.fillStyle = "#FFFFFF"; ctx.fillRect(x, y, width, height);
    ctx.fillStyle = "#BC002D"; ctx.beginPath(); ctx.arc(x + width/2, y + height/2, height*0.3, 0, Math.PI*2); ctx.fill();
}
function drawCoverArt() {
    const c = document.getElementById('coverCanvas');
    const cx = c.getContext('2d');
    cx.clearRect(0,0,340,220);
    const grad = cx.createLinearGradient(0,0,0,220); grad.addColorStop(0, "#001a33"); grad.addColorStop(1, "#004080");
    cx.fillStyle = grad; cx.fillRect(0,0,340,220);
    drawChinaFlag(cx, 10, 20, 80);
    cx.save(); cx.translate(100, 100); cx.scale(1.2, 1.2); cx.rotate(0.2); drawPlaneBody(cx, "#263238", "#d50000"); cx.restore();
    cx.fillStyle = "white"; cx.font = "italic 900 40px Arial"; cx.shadowColor="black"; cx.shadowBlur=10; cx.textAlign = "center"; cx.fillText("VS", 170, 180); cx.shadowBlur=0;
    cx.save(); cx.translate(240, 100); cx.scale(1.2, 1.2); cx.rotate(-0.2); cx.scale(-1, 1); drawEnemyBody(cx, "#cfd8dc", "#d32f2f"); cx.restore();
    drawJapanFlag(cx, 250, 20, 80);
}
setTimeout(drawCoverArt, 100);

const keys = {};
document.querySelectorAll('.d-btn, .fire-btn').forEach(btn => {
    btn.addEventListener('touchstart', (e) => { e.preventDefault(); keys[btn.dataset.key] = true; btn.style.transform='scale(0.9)'; });
    btn.addEventListener('touchend', (e) => { e.preventDefault(); keys[btn.dataset.key] = false; btn.style.transform='scale(1)'; });
});
window.onkeydown = e => keys[e.code] = true;
window.onkeyup = e => keys[e.code] = false;

const Game = {
    active: false, paused: false, score: 0, kills: 0, weaponLevel: 1, gameTime: 0, divisionCount: 1, bossMode: false,
    init: function() { AudioSys.init(); this.start(); },
    start: function() {
        document.getElementById('startScreen').classList.add('hidden');
        document.getElementById('gameOverScreen').classList.add('hidden');
        document.getElementById('victoryScreen').classList.add('hidden');
        bossHpBar.style.display = 'none';
        AudioSys.setTheme('battle');
        this.active = true; this.paused = false; this.bossMode = false;
        this.score = 0; this.kills = 0; this.weaponLevel = 1; this.gameTime = 0; this.divisionCount = 1;
        this.updateUI(); player.reset();
        bullets = []; enemies = []; ships = []; shipBullets = []; powerups = []; particles = []; boss = null;
        lastTime = performance.now();
        requestAnimationFrame(loop);
    },
    restart: function() { this.start(); },
    nextLevel: function() {
        document.getElementById('victoryScreen').classList.add('hidden');
        this.paused = false; this.gameTime = 0; this.bossMode = false;
        AudioSys.setTheme('battle');
        boss = null; bossHpBar.style.display = 'none';
        lastTime = performance.now();
        requestAnimationFrame(loop);
    },
    winStage: function() {
        this.paused = true; this.divisionCount++;
        document.getElementById('victoryText').innerText = `ÂáªË¥•Ëà™Á©∫Ëá™Âç´ÈòüÁ¨¨ ${this.divisionCount-1} Â∏àÂõ¢`;
        document.getElementById('victoryScreen').classList.remove('hidden');
    },
    over: function() {
        this.active = false;
        document.getElementById('finalScore').innerText = "ÊúÄÁªàÂæóÂàÜ: " + this.score;
        document.getElementById('gameOverScreen').classList.remove('hidden');
    },
    updateUI: function() {
        scoreEl.innerText = "ÂæóÂàÜ: " + this.score;
        let timeLeft = Math.max(0, 120 - Math.floor(this.gameTime));
        timerEl.innerText = this.bossMode ? "BOSS Áé∞Ë∫´!" : `Ë∑ùÊïåËà∞: ${timeLeft}s`;
        timerEl.style.color = this.bossMode ? "#ff0000" : "#00ff00";
        let lvText = this.weaponLevel + "Á∫ß"; if(this.weaponLevel === 6) lvText = "MAX";
        weaponEl.innerText = "ÁÅ´Âäõ: " + lvText;
    }
};

function drawPlaneBody(ctx, c, sc) {
    ctx.fillStyle = "#00ccff"; ctx.shadowBlur = 15; ctx.shadowColor = "#00ccff"; ctx.beginPath(); ctx.moveTo(-5, 45); ctx.lineTo(0, 65 + Math.random()*10); ctx.lineTo(5, 45); ctx.fill(); ctx.shadowBlur = 0;
    let gradBody = ctx.createLinearGradient(-10, 0, 10, 0); gradBody.addColorStop(0, "#1a2327"); gradBody.addColorStop(0.5, "#37474f"); gradBody.addColorStop(1, "#1a2327");
    let gradWing = ctx.createLinearGradient(0, -20, 0, 40); gradWing.addColorStop(0, "#263238"); gradWing.addColorStop(1, "#10181b");
    ctx.fillStyle = "#111"; ctx.beginPath(); ctx.moveTo(-8, 40); ctx.lineTo(-12, 45); ctx.lineTo(-4, 45); ctx.lineTo(-8, 40); ctx.moveTo(8, 40); ctx.lineTo(4, 45); ctx.lineTo(12, 45); ctx.lineTo(8, 40); ctx.fill();
    ctx.fillStyle = gradWing; ctx.beginPath(); ctx.moveTo(0, -10); ctx.lineTo(38, 35); ctx.lineTo(38, 42); ctx.lineTo(10, 35); ctx.lineTo(0, 40); ctx.lineTo(-10, 35); ctx.lineTo(-38, 42); ctx.lineTo(-38, 35); ctx.closePath(); ctx.fill();
    ctx.strokeStyle = "rgba(0,0,0,0.3)"; ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(10,35); ctx.lineTo(30,38); ctx.stroke(); ctx.beginPath(); ctx.moveTo(-10,35); ctx.lineTo(-30,38); ctx.stroke();
    ctx.fillStyle = "#455a64"; ctx.beginPath(); ctx.moveTo(10, -15); ctx.lineTo(24, -5); ctx.lineTo(10, 0); ctx.fill(); ctx.moveTo(-10, -15); ctx.lineTo(-24, -5); ctx.lineTo(-10, 0); ctx.fill();
    ctx.fillStyle = gradBody; ctx.beginPath(); ctx.moveTo(0, -45); ctx.quadraticCurveTo(6, -30, 8, -10); ctx.lineTo(9, 30); ctx.lineTo(0, 40); ctx.lineTo(-9, 30); ctx.quadraticCurveTo(-6, -30, 0, -45); ctx.fill();
    ctx.fillStyle = "#263238"; ctx.beginPath(); ctx.moveTo(8, 25); ctx.lineTo(16, 45); ctx.lineTo(8, 45); ctx.fill(); ctx.moveTo(-8, 25); ctx.lineTo(-16, 45); ctx.lineTo(-8, 45); ctx.fill();
    ctx.fillStyle = "#000"; ctx.beginPath(); ctx.moveTo(5, 35); ctx.lineTo(8, 48); ctx.lineTo(5, 48); ctx.fill(); ctx.moveTo(-5, 35); ctx.lineTo(-8, 48); ctx.lineTo(-5, 48); ctx.fill();
    let gradCockpit = ctx.createLinearGradient(-3, -25, 3, -25); gradCockpit.addColorStop(0, "#b8860b"); gradCockpit.addColorStop(0.5, "#ffd700"); gradCockpit.addColorStop(1, "#b8860b");
    ctx.fillStyle = gradCockpit; ctx.beginPath(); ctx.ellipse(0, -22, 3, 7, 0, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = "rgba(255,255,255,0.7)"; ctx.beginPath(); ctx.ellipse(-1, -24, 1, 3, 0, 0, Math.PI*2); ctx.fill();
    drawStar(ctx, -25, 25, 5, 2, sc); drawStar(ctx, 25, 25, 5, 2, sc);
}

function drawDestroyer(ctx) {
    ctx.fillStyle = "#546e7a"; ctx.beginPath(); ctx.moveTo(0, -45); ctx.lineTo(8, -25); ctx.lineTo(8, 45); ctx.lineTo(-8, 45); ctx.lineTo(-8, -25); ctx.closePath(); ctx.fill();
    ctx.fillStyle = "#37474f"; ctx.fillRect(-6, -20, 12, 60);
    ctx.fillStyle = "#78909c"; ctx.fillRect(-5, -15, 10, 15); ctx.fillStyle = "#263238"; ctx.fillRect(-4, -14, 8, 2);
    ctx.fillStyle = "#90a4ae"; ctx.beginPath(); ctx.arc(0, -30, 3, 0, Math.PI*2); ctx.fill(); ctx.strokeStyle = "#555"; ctx.lineWidth = 1.5; ctx.beginPath(); ctx.moveTo(0, -30); ctx.lineTo(0, -38); ctx.stroke();
    ctx.fillStyle = "#222"; for(let i=0; i<3; i++) for(let j=0; j<2; j++) ctx.fillRect(-3 + j*3, -24 + i*2, 2, 1);
    ctx.strokeStyle = "#222"; ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(0, -5); ctx.lineTo(6, 5); ctx.stroke(); ctx.beginPath(); ctx.moveTo(0, -5); ctx.lineTo(-6, 5); ctx.stroke();
    ctx.strokeStyle = "#fff"; ctx.lineWidth = 1; ctx.strokeRect(-5, 30, 10, 10); ctx.fillStyle = "#fff"; ctx.font = "8px Arial"; ctx.textAlign = "center"; ctx.fillText("H", 0, 38);
    ctx.fillStyle = "#fff"; ctx.fillRect(-2, 45, 4, 3); ctx.fillStyle = "#b71c1c"; ctx.beginPath(); ctx.arc(0, 46.5, 1, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = "rgba(255,255,255,0.4)"; ctx.beginPath(); ctx.moveTo(0, 45); ctx.lineTo(-4, 55 + Math.random()*5); ctx.lineTo(4, 55 + Math.random()*5); ctx.fill(); ctx.beginPath(); ctx.arc(0, -45, 5 + Math.random()*2, 0, Math.PI, true); ctx.fill();
}

function drawCarrierBoss(ctx) {
    ctx.fillStyle = "#455a64"; ctx.beginPath(); ctx.moveTo(-35, -90); ctx.lineTo(35, -90); ctx.lineTo(35, 90); ctx.lineTo(-35, 90); ctx.fill();
    ctx.strokeStyle = "rgba(255,255,255,0.6)"; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(-15, -85); ctx.lineTo(-15, 85); ctx.stroke(); ctx.setLineDash([8, 8]); ctx.beginPath(); ctx.moveTo(5, -85); ctx.lineTo(5, 85); ctx.stroke(); ctx.setLineDash([]);
    ctx.fillStyle = "#37474f"; ctx.shadowColor = "rgba(0,0,0,0.5)"; ctx.shadowBlur = 10; ctx.shadowOffsetX = -5; ctx.fillRect(20, -30, 12, 50); ctx.shadowBlur = 0; ctx.shadowOffsetX = 0;
    ctx.fillStyle = "#111"; ctx.fillRect(20, -25, 2, 10);
    ctx.fillStyle = "#546e7a"; ctx.fillRect(35, -60, 8, 25); ctx.fillRect(35, 40, 8, 25);
    ctx.fillStyle = "#eee"; ctx.beginPath(); ctx.arc(-30, -85, 3, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(-30, 85, 3, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = "#fff"; ctx.fillRect(-10, 80, 20, 12); ctx.fillStyle = "#b71c1c"; ctx.beginPath(); ctx.arc(0, 86, 4, 0, Math.PI*2); ctx.fill();
    for(let i=0; i<8; i++) { ctx.save(); ctx.translate(0, 86); ctx.rotate(i * Math.PI/4); ctx.fillRect(0, -1, 10, 2); ctx.restore(); }
}

function drawEnemyBody(ctx, c, fc) {
    ctx.fillStyle = "#263238"; ctx.beginPath(); const serrations = 6; for (let i = 0; i <= serrations * 2; i++) { let angle = Math.PI * 0.8 + (i / (serrations * 2)) * (Math.PI * 1.4); let r = (i % 2 === 0) ? 6 : 4; ctx.lineTo(Math.cos(angle) * r, 38 + Math.sin(angle) * 2); } ctx.fill();
    let grad = ctx.createLinearGradient(-15, 0, 15, 0); grad.addColorStop(0, "#546e7a"); grad.addColorStop(0.5, "#cfd8dc"); grad.addColorStop(1, "#546e7a");
    ctx.fillStyle = grad; ctx.beginPath(); ctx.moveTo(0, -35); ctx.lineTo(-4, -18); ctx.lineTo(-8, -5); ctx.lineTo(-35, 15); ctx.lineTo(-35, 22); ctx.lineTo(-12, 28); ctx.lineTo(-18, 38); ctx.lineTo(-5, 38); ctx.lineTo(5, 38); ctx.lineTo(18, 38); ctx.lineTo(12, 28); ctx.lineTo(35, 22); ctx.lineTo(35, 15); ctx.lineTo(8, -5); ctx.lineTo(4, -18); ctx.closePath(); ctx.fill();
    ctx.strokeStyle = "rgba(255,255,255,0.15)"; ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(-10, 5); ctx.lineTo(-30, 20); ctx.stroke(); ctx.beginPath(); ctx.moveTo(10, 5); ctx.lineTo(30, 20); ctx.stroke(); ctx.beginPath(); ctx.moveTo(0, -10); ctx.lineTo(0, 20); ctx.stroke();
    ctx.fillStyle = "#455a64"; ctx.beginPath(); ctx.moveTo(-5, 25); ctx.lineTo(-14, 42); ctx.lineTo(-8, 42); ctx.lineTo(-2, 30); ctx.fill(); ctx.beginPath(); ctx.moveTo(5, 25); ctx.lineTo(14, 42); ctx.lineTo(8, 42); ctx.lineTo(2, 30); ctx.fill();
    let gradGlass = ctx.createLinearGradient(-3, -25, 3, -25); gradGlass.addColorStop(0, "#b8860b"); gradGlass.addColorStop(0.5, "#ffd700"); gradGlass.addColorStop(1, "#b8860b");
    ctx.fillStyle = gradGlass; ctx.beginPath(); ctx.ellipse(0, -18, 3.5, 6, 0, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = "rgba(255,255,255,0.8)"; ctx.beginPath(); ctx.ellipse(-1.5, -20, 1, 2, 0, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = fc; ctx.shadowColor = "rgba(0,0,0,0.2)"; ctx.shadowBlur = 2; ctx.beginPath(); ctx.arc(-20, 15, 3.5, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(20, 15, 3.5, 0, Math.PI*2); ctx.fill(); ctx.shadowBlur = 0;
}
function drawStar(ctx,cx,cy,r,ir,c){
    let rot=Math.PI/2*3; let x=cx; let y=cy; let step=Math.PI/5;
    ctx.beginPath(); ctx.moveTo(cx,cy-r);
    for(let i=0;i<5;i++){ x=cx+Math.cos(rot)*r; y=cy+Math.sin(rot)*r; ctx.lineTo(x,y); rot+=step; x=cx+Math.cos(rot)*ir; y=cy+Math.sin(rot)*ir; ctx.lineTo(x,y); rot+=step; }
    ctx.closePath(); ctx.fillStyle=c; ctx.fill();
}

class Boss {
    constructor() { this.x = canvas.width/2; this.y = -150; this.maxHp = 500+(Game.divisionCount*200); this.hp = this.maxHp; this.state = 'entering'; this.dir = 1; this.shootTimer = 0; }
    update(dt) {
        if(this.state === 'entering') { this.y += 50 * dt; if(this.y >= 80) this.state = 'fight'; } else {
            this.x += 40 * this.dir * dt; if(this.x > canvas.width - 60) this.dir = -1; if(this.x < 60) this.dir = 1;
            this.shootTimer -= dt; if(this.shootTimer <= 0) { for(let i=-2; i<=2; i++) shipBullets.push({x: this.x, y: this.y+80, vx: i*100, vy: 300, isBoss: true}); this.shootTimer = 1.2; }
        }
    }
    draw() { ctx.save(); ctx.translate(this.x, this.y); drawCarrierBoss(ctx); ctx.restore(); }
}

const player={x:0,y:0,speed:350,cooldown:0,reset:function(){this.x=canvas.width/2;this.y=canvas.height-120;},update:function(dt){if(keys.ArrowLeft&&this.x>25)this.x-=this.speed*dt;if(keys.ArrowRight&&this.x<canvas.width-25)this.x+=this.speed*dt;if(keys.ArrowUp&&this.y>50)this.y-=this.speed*dt;if(keys.ArrowDown&&this.y<canvas.height-50)this.y+=this.speed*dt;if(this.cooldown>0)this.cooldown-=dt;if(keys.Space&&this.cooldown<=0)this.shoot();},shoot:function(){
    AudioSys.playShoot();
    const x=this.x,y=this.y-20,speed=-800; this.cooldown=(Game.weaponLevel>=4?0.12:0.15); if(Game.weaponLevel===6)this.cooldown=0.08;
    if(Game.weaponLevel===1)bullets.push({x:x,y:y,vx:0,vy:speed,type:1});
    else if(Game.weaponLevel===2){bullets.push({x:x-10,y:y,vx:0,vy:speed,type:1});bullets.push({x:x+10,y:y,vx:0,vy:speed,type:1});}
    else if(Game.weaponLevel===3){bullets.push({x:x,y:y-5,vx:0,vy:speed,type:1});bullets.push({x:x-15,y:y,vx:-150,vy:speed*0.9,type:1});bullets.push({x:x+15,y:y,vx:150,vy:speed*0.9,type:1});}
    else if(Game.weaponLevel===4){bullets.push({x:x-8,y:y-5,vx:0,vy:speed,type:2});bullets.push({x:x+8,y:y-5,vx:0,vy:speed,type:2});bullets.push({x:x-25,y:y,vx:-200,vy:speed*0.9,type:2});bullets.push({x:x+25,y:y,vx:200,vy:speed*0.9,type:2});}
    else if(Game.weaponLevel===5){bullets.push({x:x,y:y-10,vx:0,vy:speed,type:3});bullets.push({x:x-15,y:y-5,vx:-100,vy:speed,type:3});bullets.push({x:x+15,y:y-5,vx:100,vy:speed,type:3});bullets.push({x:x-35,y:y,vx:-300,vy:speed*0.9,type:3});bullets.push({x:x+35,y:y,vx:300,vy:speed*0.9,type:3});}
    else if(Game.weaponLevel===6){bullets.push({x:x,y:y-10,vx:0,vy:-1200,type:4});bullets.push({x:x-12,y:y-5,vx:-50,vy:-1200,type:4});bullets.push({x:x+12,y:y-5,vx:50,vy:-1200,type:4});bullets.push({x:x-30,y:y,vx:-300,vy:-1000,type:4});bullets.push({x:x+30,y:y,vx:300,vy:-1000,type:4});bullets.push({x:x-50,y:y+10,vx:-600,vy:-900,type:4});bullets.push({x:x+50,y:y+10,vx:600,vy:-900,type:4});}
},draw:function(){ctx.save();ctx.translate(this.x,this.y);drawPlaneBody(ctx,"#263238","#d50000");ctx.restore();}};

let bullets=[],enemies=[],ships=[],shipBullets=[],powerups=[],particles=[],spawnTimer=0,shipTimer=0,boss=null,lastTime=0;

function loop(timestamp) {
    if(!Game.active || Game.paused) return;
    let dt = (timestamp - lastTime) / 1000; lastTime = timestamp; if(dt > 0.1) dt = 0.1;
    let bgGrad = ctx.createLinearGradient(0,0,0,canvas.height); bgGrad.addColorStop(0,"#003366"); bgGrad.addColorStop(1,"#001a33"); ctx.fillStyle = bgGrad; ctx.fillRect(0,0,canvas.width,canvas.height);
    Game.bgOffset=(Game.bgOffset+200*dt)%100; ctx.fillStyle="rgba(255,255,255,0.05)"; for(let i=0;i<10;i++){let y=(Game.bgOffset+i*100)%canvas.height;ctx.beginPath();ctx.arc(canvas.width*0.2,y,40,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.arc(canvas.width*0.8,y+50,60,0,Math.PI*2);ctx.fill();}

    if(!Game.bossMode) { Game.gameTime += dt; Game.updateUI(); if(Game.gameTime >= 120) { Game.bossMode = true; boss = new Boss(); bossHpBar.style.display = 'block'; enemies = []; ships = []; AudioSys.setTheme('boss'); } }
    if(boss) { boss.update(dt); boss.draw(); bossHpFill.style.width = (boss.hp/boss.maxHp*100)+"%"; for(let j=bullets.length-1; j>=0; j--) { if(Math.abs(boss.x-bullets[j].x)<50 && Math.abs(boss.y-bullets[j].y)<90) { bullets.splice(j,1); boss.hp-=2; createExplosion(boss.x+(Math.random()-0.5)*60, boss.y+(Math.random()-0.5)*100, 3, "#fff"); if(boss.hp<=0) { createExplosion(boss.x,boss.y,80,"#ffaa00"); Game.score+=5000; Game.winStage(); return; } } } }
    if(!Game.bossMode) { 
        shipTimer-=dt; 
        if(shipTimer<=0){ships.push({x:Math.random()*(canvas.width-40)+20,y:-80,hp:5});shipTimer=5;} 
        for(let i=ships.length-1; i>=0; i--) { 
            let s=ships[i]; s.y+=50*dt; 
            ctx.save(); ctx.translate(s.x,s.y); 
            drawDestroyer(ctx); 
            ctx.restore(); 
            if(Math.random()<0.01) shipBullets.push({x:s.x,y:s.y,vx:(player.x-s.x)*0.5,vy:-300}); 
            for(let j=bullets.length-1; j>=0; j--) { 
                if(Math.abs(s.x-bullets[j].x)<15 && Math.abs(s.y-bullets[j].y)<40){ 
                    bullets.splice(j,1); s.hp--; createExplosion(s.x,s.y,5,"#fff"); 
                    if(s.hp<=0){createExplosion(s.x,s.y,40,"#ffaa00");ships.splice(i,1);Game.score+=50;} break; 
                } 
            } 
            if(s.y>canvas.height+50) ships.splice(i,1); 
        } 
    }
    
    // --- FLASHING BULLETS LOGIC ---
    for(let i=shipBullets.length-1; i>=0; i--) { 
        let b=shipBullets[i]; b.x+=b.vx*dt; b.y+=b.vy*dt; 
        ctx.save(); ctx.translate(b.x, b.y);
        let flash = Math.sin(Date.now() / 50); 
        ctx.shadowBlur = 15; ctx.shadowColor = flash > 0 ? "#ff0000" : "#ffaa00"; 
        ctx.fillStyle = flash > 0 ? "#fff" : "#ff4400"; 
        ctx.beginPath(); ctx.arc(0, 0, b.isBoss?7:5, 0, Math.PI*2); ctx.fill();
        ctx.restore();
        if(Math.hypot(b.x-player.x, b.y-player.y)<20) { createExplosion(player.x,player.y,50,"#ff0000"); Game.over(); } 
        if(b.y<-10||b.x<0||b.x>canvas.width||b.y>canvas.height) shipBullets.splice(i,1); 
    }

    player.update(dt); player.draw();
    for(let i=bullets.length-1; i>=0; i--) { let b=bullets[i]; b.x+=b.vx*dt; b.y+=b.vy*dt; if(b.type===4){ctx.fillStyle=Math.random()>0.5?"#fff":"#f00";ctx.fillRect(b.x-3,b.y,6,30);} else if(b.type===3){ctx.fillStyle="#ffcc00";ctx.fillRect(b.x-2.5,b.y,5,20);} else {ctx.fillStyle="#00ccff";ctx.fillRect(b.x-1.5,b.y,3,15);} if(b.y<-30) bullets.splice(i,1); }
    
    if(!Game.bossMode) { 
        spawnTimer-=dt; 
        let rate=0.8-(Math.min(Game.score,5000)/10000); 
        if(spawnTimer<=0){enemies.push({x:Math.random()*(canvas.width-60)+30,y:-60,speed:150+Math.random()*200});spawnTimer=Math.max(0.3,rate);} 
        for(let i=enemies.length-1; i>=0; i--) { 
            let e=enemies[i]; e.y+=e.speed*dt; 
            ctx.save(); ctx.translate(e.x,e.y); ctx.rotate(Math.PI); drawEnemyBody(ctx,"#cfd8dc","#d32f2f"); ctx.restore(); 
            let hit=false; 
            if(Math.random() < 0.005) { shipBullets.push({x: e.x, y: e.y + 10, vx: 0, vy: 250, isBoss: false}); }
            for(let j=bullets.length-1; j>=0; j--){if(Math.abs(e.x-bullets[j].x)<25 && Math.abs(e.y-bullets[j].y)<25){hit=true;bullets.splice(j,1);killEnemy(e.x,e.y);enemies.splice(i,1);break;}} 
            if(!hit && Math.hypot(e.x-player.x, e.y-player.y)<40){createExplosion(player.x,player.y,50,"#ff0000");Game.over();} 
            else if(e.y>canvas.height+50) enemies.splice(i,1); 
        } 
    }
    
    for(let i=powerups.length-1; i>=0; i--){let p=powerups[i];p.y+=120*dt;p.rot+=3*dt;ctx.save();ctx.translate(p.x,p.y);ctx.rotate(p.rot);let hue=(Date.now()/5)%360; let c=`hsl(${hue},100%,60%)`;ctx.shadowBlur=15;ctx.shadowColor=c;drawStar(ctx,0,0,16,7,c);ctx.fillStyle="#000";ctx.font="bold 14px Arial";ctx.textAlign="center";ctx.textBaseline="middle";ctx.fillText("P",0,1);ctx.restore();if(Math.hypot(p.x-player.x,p.y-player.y)<40){upgradePlayer();powerups.splice(i,1);}else if(p.y>canvas.height)powerups.splice(i,1);}
    
    // --- UPDATED PARTICLE RENDERER (BRILLIANT SPARKS) ---
    ctx.save();
    ctx.globalCompositeOperation = "lighter"; 
    for(let i=particles.length-1; i>=0; i--){
        let p=particles[i]; p.x+=p.vx*dt; p.y+=p.vy*dt; p.life-=dt; p.vx *= 0.95; p.vy *= 0.95;
        ctx.globalAlpha=p.life; ctx.fillStyle=p.color; ctx.beginPath(); ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fill();
        if(p.life<=0)particles.splice(i,1);
    }
    ctx.restore();

    requestAnimationFrame(loop);
}

function killEnemy(x,y){createExplosion(x,y,15,"#ff9800");Game.score+=10;Game.kills++;Game.updateUI();if(Game.kills%15===0)powerups.push({x:x,y:y,rot:0});}
function upgradePlayer(){if(Game.weaponLevel<6){Game.weaponLevel++;showFloatText(player.x,player.y,"ÁÅ´ÂäõÂçáÁ∫ß!","#00ff00");}else{Game.score+=500;showFloatText(player.x,player.y,"MAX GUN","MAX");}AudioSys.playShoot();Game.updateUI();}
function createExplosion(x,y,c,col){for(let i=0;i<c*3;i++) { particles.push({ x:x, y:y, vx:(Math.random()-0.5)*800, vy:(Math.random()-0.5)*800, life:0.4+Math.random()*0.4, color:col, size:0.5+Math.random()*1.5 }); }}
function showFloatText(x,y,t,c){let d=document.createElement('div');d.innerText=t;d.style.position='absolute';d.style.left=(x+20)+'px';d.style.top=y+'px';d.style.fontWeight='bold';d.style.textShadow='0 0 5px black';d.style.pointerEvents='none';d.style.transition='all 1s ease-out';if(c==="MAX"){d.style.fontSize='16px';d.style.color='#ff0000';d.style.animation='hue 0.5s infinite linear';d.style.fontWeight='900';}else{d.style.fontSize='20px';d.style.color=c;}document.getElementById('gameContainer').appendChild(d);setTimeout(()=>{d.style.top=(y-50)+'px';d.style.opacity=0;},50);setTimeout(()=>d.remove(),1000);}
</script>
</body>
</html>